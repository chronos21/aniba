<%- include('./header') %>

<div class="ui container">
    <div>
        <a href="<%= data.url %>">All Episodes</a>
        <span> | </span>
        <a href="<%= data.prev %>">Previous</a>
        <span> | </span>
        <a href="<%= data.next %>">Next</a>
    </div>
    <h1 class="mb-4"><%= data.title %></h1>
    <div style="width: 100%; height: 100%; background-color: black; margin-bottom: 30px;">
        <video src="/video?url=<%= data.video %>&embed=<%= data.embed %>" width="100%" height="100%" controls></video>
    </div>

    <div style="margin-bottom: 30px;">
        <h3 class="ui dividing header">Comments</h3>
        <div id="comment-list" class="ui comments">

        </div>

        <form class="ui reply form" id="comment-form" onsubmit="postComment(event)">
            <div class="field">
                <textarea id="comment-box"></textarea>
            </div>
            <button class="ui blue labeled submit icon button">
                <i class="icon edit"></i> Add Reply
            </button>
        </form>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<script>
    const parentId = '<%= url %>'
    let authorId = localStorage.getItem('authorId')
    if (!authorId) authorId = localStorage.setItem('authorId', Date.now())

    getComments()

    setInterval(() => getComments(), 30000)

    function getComments() {

        axios.get('/api/comments/' + parentId)
            .then(res => {
                console.log(res)
                let commentList = document.querySelector('#comment-list')
                let { comments } = res.data
                commentList.innerHTML = ''
                for (let comment of comments) {
                    let item = makeComment(comment.authorId, comment.text, comment.createdAt)
                    commentList.innerHTML += item
                }
            })
    }

    function makeComment(name, content, date) {
        return `<div class="comment">
            <a class="avatar">
                <img src="/images/avatar.jpg">
            </a>
            <div class="content">
                <a class="author">Anonymous</a> [${name ? name : Date.now()}] 
                <div class="metadata">
                    <span class="date">${moment(date).fromNow()}</span>
                </div>
                <div class="text">
                    ${content}
                </div>
            </div>
        </div>`
    }

    function postComment(e) {
        e.preventDefault()
        let text = document.querySelector('#comment-box').value
        axios.post('/api/comments/' + parentId, { text, authorId })
            .then((res) => {
                let { comment } = res.data
                let commentList = document.querySelector('#comment-list')
                let item = makeComment(comment.authorId, comment.text, comment.createdAt)
                document.querySelector('#comment-box').value = ''
                commentList.innerHTML += item
            })
    }
</script>
<%- include('./footer') %>